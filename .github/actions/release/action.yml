name: Releasing APK files
runs:
  using: "composite"
  steps:
    - name: Delete existing release
      shell: bash
      run: |
        # Get release ID
        release_id=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/releases/tags/all" | \
          jq -r '.id')
        
        if [ "$release_id" != "null" ]; then
          # Get asset IDs
          asset_ids=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/$release_id/assets" | \
            jq -r '.[].id')
          
          # Delete each asset with proper headers and error handling
          for asset_id in $asset_ids; do
            echo "Deleting asset $asset_id..."
            curl -X DELETE \
              -H "Authorization: Bearer ${{ github.token }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/releases/assets/$asset_id"
            sleep 1
          done
        fi
    - name: Generate release info
      shell: bash
      run: |
        echo "
        **Change log** :point_down:
        [Revanced](https://github.com/revanced/revanced-patches/releases)
        [Revanced Extended](https://github.com/inotia00/revanced-patches/releases)
        [Revanced Extended anddea](https://github.com/anddea/revanced-patches/releases)
        [Revanced Extended for Android 6 & 7](https://github.com/kitadai31/revanced-patches-android6-7/releases)
        [Revanced Extended For Android 5:](https://github.com/d4n3436/revanced-patches-android5/releases)
        "> ${{ github.workspace }}-CHANGELOG.txt
    - name: Release
      uses: ncipollo/release-action@v1.14.0
      with:
        artifacts: |
          ./release/*.apk
        name: Revanced & Revanced Extended
        tag: all
        bodyFile: ${{ github.workspace }}-CHANGELOG.txt
        allowUpdates: true
        removeArtifacts: true
        replacesArtifacts: true
        artifactErrorsFailBuild: true
        artifactContentType: application/vnd.android.package-archive
